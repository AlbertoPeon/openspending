<html xmlns:py="http://genshi.edgewall.org/"
  xmlns:i18n="http://genshi.edgewall.org/i18n"
  xmlns:xi="http://www.w3.org/2001/XInclude"
  py:strip="">
  <xi:include href="_nav.html" />

  <py:def function="nav_class">nav-editor</py:def>

  <py:def function="page_title">${c.dataset.label or c.dataset.name}</py:def>
  
  <py:def function="optional_head">
    <style>
      #frame {
        display: none;
        position: relative;
        height: 305px;
      }

      #column-names .used {
        text-decoration: line-through;
        background-color: #ffffff;
      }

      #column-names-container {
        text-align: right;
      }

      #column-names-container h3 {
        padding: 5px;
      }
      
      #column-names-container li {
        list-style-type: none;
      }

      .rm_dimension {
        float: right;
      }
    </style>

    <script>
      var validDimensionType = function(ty) {
        var validTypes = [ 'attribute', 'value', 'date', 'measure' ];
        return ($$.inArray(ty, validTypes) !== -1);
      };
    </script>
  </py:def>

  <div py:def="content">
    ${editor_nav('dimensions')}
    
    <div id="m1">
      <div class="forms dimensions_widget">
        <form action="#">
          <div class="row">
            <div class="span3">
              <p>
                <a class='btn btn-primary' data-backdrop="static"
                                data-controls-modal="add-dimension"
                                data-keyboard="false" href='#'>
                  <i class="icon-plus icon-white"></i>
                  Add Dimension</a>
              </p>
              <p class="help-block">
                Make sure your dimensions import all source data columns.<br/><br/>
              </p>

              <p>
                <a class='btn btn-primary' data-backdrop="true"
                                data-controls-modal="check-uniques"
                                data-keyboard="true" href='#'>Set Unique Dimensions</a>
              </p>
              <p class="help-block">
                Identify the dimensions that help to identify each entry.<br/><br/>
              </p>

              <h3>Exisiting Dimensions</h3>
              <div class="well">
                <ul id="names-hook" class="dimension-names nav nav-list">
                </ul>
              </div>


              <!-- Unique dimensions selector window. --> 
              <div id="check-uniques" class="modal hide fade">
                <div class="modal-header">
                  <h3>Specify which dimensions identify an entry uniquely</h3>
                </div>
                <form action='#'>
                  <div class="modal-body">
                    <ul id="uniques" style="list-style: none;">
                    </ul>
                  </div>
                  <div class="modal-footer">
                    <a class='btn set_uniques btn-success'>Update</a>
                  </div>
                </form>
              </div>

              <!-- Add dimension window. -->
              <div id="add-dimension" class="modal hide fade">
                <div class="modal-header">
                  <h3>Add new dimension</h3>
                </div>
                <form action='#' class="form-horizontal">
                  <div class="modal-body">
                    <div style="padding: 4px">
                      <p>
                        The name you choose should only contain letters, numbers and dashes (i.e., no spaces)
                      </p>
                      <p i18n:msg="">
                        Where the dimension represents the ultimate source or destination of the funds, 
                        call it <code>from</code> or <code>to</code>.
                      </p>
                      </div>
                        <div class="control-group">
                          <label for="new-dimension-name">Name</label>
                          <div class="controls">
                            <input type='text' name='new-dimension-name' value='' />
                          </div>
                        </div>
                        <div class="control-group">
                          <label for="new-dimension-type">Type</label>
                          <div class="controls">
                            <label class="checkbox">
                              <input id='dimension_type' type="radio" name="new-dimension-type" value="compound" />
                              Dimension
                              <p class="help-block">
                                A defined set, like suppliers or classifications, with 
                                multiple attributes (e.g. supplier name and VAT number).
                              </p>
                            </label>
                            <label class="checkbox">
                              <input id='dimension_type' type="radio" name="new-dimension-type" value="attribute" />
                              Attribute
                              <p class="help-block">
                                A simple value, e.g. descriptions or transaction IDs.
                              </p>
                            </label>
                            <label class="checkbox">
                              <input id='dimension_type' type="radio" name="new-dimension-type" value="date" />
                              Date
                              <p class="help-block">
                                Temporal value, e.g. start of project, date of disbursement.
                              </p>
                            </label>
                            <label class="checkbox">
                              <input id='dimension_type' type="radio" name="new-dimension-type" value="measure" />
                              Measure
                              <p class="help-block">
                                Monetary information, e.g. amount disbursed or allocated.
                              </p>
                            </label>
                          </div>
                        </div>
                      </div>
                      <div class="modal-footer">
                        <a class='btn cancel_add_dimension btn-danger'>Cancel</a>
                        <a class='btn add_dimension btn-success'>Add</a>
                      </div>
                    </form>
                  </div>

                </div>

      <div class="span9">

                                <py:if test="len(c.errors.keys())">
                  <div class="alert block-message alert-error">
                                        <p>
                                          The dimensions mapping could not be saved as it 
                                          contains some errors:
                                        </p>
                                        <ul py:for="field, error in c.errors.items()">
                      <li><strong>${field}:</strong> ${error}</li>
                                        </ul>
                  </div>
                                </py:if>
                 

          <div class="modeleditor tab-content dimensions">
                        <div class='tab-pane active' id='help'>
                          <div class='forms'>
                                <form action="#">

                                  <!-- Dimension mapping -->
                                        <h3>Dimension mapping</h3>
                                        <p i18n:msg="">
                                          The first and most important step in the creation of a model is
                                          the mapping of columns in the data file to "dimensions", the logical
                                          divisions of the dataset. The four required dimensions, <code>amount</code>,
                                          <code>time</code>, <code>from</code>, and <code>to</code> are laid
                                          out below, and you can add your own dimensions using the links at
                                          the bottom of the page.
                                        </p>
                                        <h3>What do I do here?</h3>
                                        <p>
        To create a model, you need to define the dimensions of your dataset
        in a JSON (JavaScript Object Notation) schema. Using the
        auto-generated schema, you likely need to define
        measures and compound dimensions.
        </p>
        <ul>
          <li><strong><a
            href="http://docs.openspending.org/en/latest/model/design.html#dimension-and-mapping-definitions">Schema
            documentation</a></strong></li>
          <li><a href="${h.url(controller='help', action='page',
            path='api-olap.html')}">Background: How does OpenSpending store data?</a></li>
          <li><a href="http://wiki.openspending.org/Mapping_Format">Schema wiki</a></li>
        </ul>


                                </form>
                          </div> <!-- /.forms -->

                          <!-- Dimension column field template -->
                          <script id='tpl_dimension_field' type='text/x-jquery-tmpl'>
                                <tr data-field-name='$${fieldName}'>
                                  <td>$${fieldName}</td>
                                  <td><select class='column' name='$${prefix(fieldName)}[column]'></select></td>
                                  <td>
                                        <select name='$${prefix(fieldName)}[datatype]'>
                                          <option value='string'>string</option>
                                          <option value='float'>float</option>
                                          <option value='id'>id</option>
                                          <option value='date'>date</option>
                                        </select>
                                  </td>
                                  <td>
                                    <input type='short' class='span3' name='$${prefix(fieldName)}[default_value]' placeholder="Default Value" />
                                  </td>
                                  <td>
                                        {{if required(fieldName) != true}}
                                        <a href='#' class='field_rm'><i class="icon-remove"></i></a>
                                        {{/if}}
                                  </td>
                                </tr>
                          </script>

                          <!-- Dimension template -->
                          <script id='tpl_dimension' type='text/x-jquery-tmpl'>
                            <div class="form-horizontal">
                                <input type='hidden' name='$${name}[type]' value='$${data.type}' />
                                {{if meta.fixedDataType}}
                                <input type='hidden' name='$${name}[datatype]' value='$${data.datatype}' />
                                {{/if}}
                                <legend>$${name} ($${data.type})</legend>
                                {{if meta.helpText}}<p>$${meta.helpText}</p>{{/if}}

                                <div class="control-group">
                                  <label class="control-label">Label:</label>
                                  <div class="controls">
                                      <input type='text' name='$${name}[label]' value='$${data.label}' />
                                  </div>
                                </div>
                                <div class="control-group">
                                  <div class="controls">
                                    <label class="checkbox">
                                      <input type='checkbox' name='$${name}[key]' value='true' />
                                      Include in unique key
                                    </label>
                                  </div>
                                </div>

                                {{if validDimensionType(data.type)}}
                                <div class="control-group">
                                  <label class="control-label">Column:</label>
                                  <div class="controls">
                                      <select class='column' name='$${name}[column]'></select>
                                  </div>
                                </div>
                                <hr/>
                                <div class="control-group">
                                  <label class="control-label">Default value:</label>
                                  <div class="controls">
                                      <input class='short' name='$${name}[default_value]' />
                                  </div>
                                </div>
                                {{if !meta.fixedDataType}}
                                  <div class="control-group">
                                    <label class="control-label">Data type:</label>
                                    <div class="controls">
                                      <select name='$${name}[datatype]'>
                                        <option value='string'>string</option>
                                        <option value='float'>float</option>
                                        <option value='id'>id</option>
                                        <option value='date'>date</option>
                                      </select>
                                    </div>
                                  </div>
                                {{/if}}
                                {{/if}}
                                <div class="control-group">
                                  <label class="control-label">Description:</label>
                                  <div class="controls">
                                    <textarea class='short' name='$${name}[description]'>$${data.description}</textarea>
                                  </div>
                                </div>
                                <div class="control-group">
                                  <div class="controls">
                                    <label class="checkbox">
                                      <input type='checkbox' name='$${name}[facet]' value='true' />
                                      Use as facet in entries browser
                                    </label>
                                  </div>
                                </div>
                              </div>
                                {{if !(validDimensionType(data.type))}}
                                <div><table class='table table-condensed table-striped fields'>
                                  <thead>
                                        <tr>
                                          <th>Field</th>
                                          <th>Column</th>
                                          <th>Type</th>
                                          <th>Default</th>
                                          <th>&nbsp;</th>
                                        </tr>
                                  </thead>
                                  <tbody>
                                        {{each(n, f) data.attributes}}
                                        {{tmpl({'fieldName': n, 'prefix': formFieldPrefix, 'required': formFieldRequired}) '#tpl_dimension_field'}}
                                        {{/each}}
                                  </tbody>
                                </table></div>
                                <a class='btn add_field' href='#'>Add a field</a>
                                {{/if}}
                          </script>


                        </div> <!-- /.modeleditor -->

          </div>


      </div>
    </div>
                                  <form  class="basic" id="form" action="${url(controller='editor',
                                action='dimensions_update', dataset=c.dataset.name)}" 
                                        method="POST">

                                        <textarea id="mapping" name="mapping" style="display: none">${c.fill['mapping']}</textarea>
                                    <div class="form-actions">
                                          <input id="save" value="Save Dimensions" class="btn btn-success" name="operation" type="submit" />
                                          <input type="button" class='btn btn-danger rm_all_dimensions' value="Delete All Dimensions" />

                                    </div>
                  </form>
          </form></div></div>


  </div>

  <py:def function="scripts">
    ${script_tag('vendor/jquery.tmpl')}
    ${script_tag('vendor/bootstrap-tabs')}
    ${script_tag('vendor/bootstrap-modal')}

    <script>
      $(function($) {
        $('.tabs').tabs();
      });
    </script>

    <script type="text/javascript" src="${h.static('app/dimensions-editor/main.js')}"></script>
    <script type="text/javascript" src="${h.static('app/dimensions-editor/modelEditorInit.js')}"></script>

    <script>
      jQuery(function($) {
        var config = {
          dataset: "${c.dataset.name}",
          source: "${c.source.id}",
          editorSelector: "#m1",
          fallbackSelector: '#mapping',
          namesHook: '#names-hook'
          };

        $(document).ready(function () {
          $('.dimensions_widget').show();
          initModelEditor($, config);
        });
      });
    </script>
  </py:def>

  <xi:include href="../layout.html" />
</html>

